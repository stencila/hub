{% extends 'base.html' %}

{% block title %}{{ project.name }} : Overview{% endblock %}

{% block content %}
    {% include "projects/_project_header.html" with project=project tab="overview" %}
    <div class="section">
        <div class="container">
            <p>This project is connected to the account: <strong> {{ project.account.name }}</strong></p>
            <br/>
        </div>
        <div class="columns">
            <div class="column is-9">
                {% if project.description %}
                    <p>{{ project.description }}</p>
                {% else %}
                    <p class="has-text-grey-light">No description yet</p>
                {% endif %}
            </div>
            <div class="column is-3" id="id-project-actions">
                {% comment %}
                <div class="row">
                    <a class="button is-rounded is-fullwidth is-primary"
                       href="{% url 'checkout_create' %}?project={{ project.id }}" target="_blank" title="Open">
                        <span class="icon is-small">
                          <i class="fa fa-pencil-alt"></i>
                        </span>
                        <span>Open</span>
                    </a>
                </div>
                <div class="row is-top-padding">
                    <a class="button is-rounded is-fullwidth" href="{% url 'project_archive' object.id %}">
                        <span class="icon"><i class="fas fa-download"></i></span>
                        <span>Download</span>
                    </a>
                </div>
                <div class="row is-top-padding">
                    <button class="button is-rounded is-fullwidth" type="button" @click="startSession">
                        <span class="icon is-small"><i class="fas fa-rocket"></i></span>
                        <span>Launch Session</span>
                    </button>
                </div>
                {% endcomment %}
                <div class="row is-top-padding">
                    <button class="button is-rounded is-fullwidth" type="button" @click="checkoutFiles">
                        <span class="icon is-small"><i class="fas fa-file-export"></i></span>
                        <span v-if="!checkoutInProgress">Pull Linked Sources</span>
                        <span v-if="checkoutInProgress">Pulling Linked Sources<&hellip;</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="columns is-12">
            <div id="terminal" style="display: none; width:100%; height:100%; padding: 0.5em; background: black"></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.1/es6-promise.auto.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/xterm.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/addons/fit/fit.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/addons/attach/attach.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/addons/winptyCompat/winptyCompat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/xterm@3.10.1/dist/xterm.css"/>
    <link rel="stylesheet" href="https://unpkg.com/xterm@3.10.1/dist/addons/fullscreen/fullscreen.css"/>
    <script>
      // Apply addons
      Terminal.applyAddon(attach)
      Terminal.applyAddon(fit)
      Terminal.applyAddon(winptyCompat)

      function setUpTerminal (location) {
        const term = new Terminal()
        term.winptyCompatInit()
        const container = document.getElementById('terminal')
        container.style.display = 'block'
        term.open(container)
        term.fit()
        const protocol = (window.location.protocol === 'https:') ? 'wss:' : 'ws:'
        const host = location.host ? location.host : window.location.host
        const url = `${protocol}//${host}${location.path}`
        const socket = new WebSocket(url)
        socket.onopen = (ev) => { term.attach(socket) }
        socket.onerror = (ev) => console.error(ev)
      }

      new Vue(
        {
          el: '#id-project-actions',
          delimiters: ['[[', ']]'],
          data () {
            return {
              sessionStartUrl: '{% url "session_start_v1"  project.token cloud_environ %}',
              fileCheckoutUrl: '{% url "project_pull" project.id %}',
              terminalSetup: false,
              checkoutInProgress: false
            }
          },
          methods: {
            startSession () {
              if (this.terminalSetup) {
                return
              }
              fetch(this.sessionStartUrl, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-CSRFToken': utils.cookie('csrftoken'),
                },
                credentials: 'same-origin'
              }).then(response => {
                  response.json().then(data => {
                    setUpTerminal(data.location)
                    this.terminalSetup = true
                  })
                },
                jsonFailure => {
                  console.error(jsonFailure)
                }
              ).catch(failureResponse => {
                alert(failureResponse.message)
              })
            },
            checkoutFiles () {
              this.checkoutInProgress = true
              fetch(this.fileCheckoutUrl, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-CSRFToken': utils.cookie('csrftoken'),
                },
                credentials: 'same-origin'
              }).then(
                response => {
                  this.checkoutInProgress = false
                },
                failureResponse => {
                  this.checkoutInProgress = false
                  alert(failureResponse)
                })
            }
          }
        })
    </script>
{% endblock %}
